<!DOCTYPE html>
<html>
  <head>
    <script src="fGetIPAddresses.js"></script>
    <script>
      onload = function() {
        fGetIPAddresses(
          oIFrame,
          function fGetIPAddressSuccessCallback(asIPAddresses) {
            if (asIPAddresses.length == 0) {
              document.body.appendChild(new cTreeNode("Your local IP address could not be determined.").oRootElement);
            } else {
              var aoNetworkTreeNodes = [];
              asIPAddresses.forEach(function (sIPAddress, uIndex) {
                var oNetworkTreeNode = new cTreeNode("Network for " + sIPAddress + "/8: (unknown)");
                document.body.appendChild(oNetworkTreeNode.oRootElement);
                aoNetworkTreeNodes[uIndex] = oNetworkTreeNode;
              });
              var uIndex = -1;
              function fScanNetworks() {
                if (++uIndex < asIPAddresses.length) {
                  fScanNetworkForIPAddress(asIPAddresses[uIndex], aoNetworkTreeNodes[uIndex], fScanNetworks);
                };
              };
              fScanNetworks();
              
              function fScanNetworkForIPAddress(sOwnIPAddress, oNetworkTreeNode, fCallback) {
                oNetworkTreeNode.setName("Network for " + sOwnIPAddress + "/8: (scanning...)");
                var asIPAddressComponents = /((?:[0-9]{1,3}\.){3})([0-9]{1,3})/.exec(sOwnIPAddress),
                    sFirstBytes = asIPAddressComponents[1],
                    sLastByte = asIPAddressComponents[2],
                    aoMachineTreeNodes = [];
                for (var uLastByte = 0; uLastByte < 256; uLastByte++) {
                  sNodeIPAddress = sFirstBytes + uLastByte;
                  aoMachineTreeNodes[uLastByte] = oNetworkTreeNode.appendChild(new cTreeNode(sNodeIPAddress == sOwnIPAddress ? sNodeIPAddress + " (you)" : ""));
                };
                uLastByte = -1;
                function fScanAddressRange() {
                  if (++uLastByte < 256) {
                    if (sFirstBytes + uLastByte == sOwnIPAddress) {
                      fScanAddressRange();
                    } else {
                      fScanIPAddress(sFirstBytes + uLastByte, aoMachineTreeNodes[uLastByte], fScanAddressRange);
                    };
                  } else {
                    oNetworkTreeNode.setName("Network for " + sOwnIPAddress + "/8:");
                    fCallback();
                  };
                }
                for (var uThreads = 100; uThreads--;) {
                  fScanAddressRange();
                };
              };
            };
          },
          function fGetIPAddressErrorCallback(sErrorMessage) {
            document.body.appendChild(new cTreeNode(sErrorMessage).oRootElement);
          }
        );
      };
      
      function fScanIPAddress(sIPAddress, oMachineTreeNode, fCallback) {
        // In a browser on Windows, Linux machines seem to respond to any port, so picking 28876 at random.
        oMachineTreeNode.setName(sIPAddress + " (scanning port 28876...)");
        fScanIPAddressAndPort(sIPAddress, 28876, function (bDetected) {
          if (bDetected) {
            oMachineTreeNode.setName(sIPAddress + " (unknown OS)")
            fCallback();
          } else { // SMB over IP
            oMachineTreeNode.setName(sIPAddress + " (scanning port 445...)");
            fScanIPAddressAndPort(sIPAddress, 445, function (bDetected) {
              if (bDetected) {
                oMachineTreeNode.setName(sIPAddress + " (Windows)")
                fCallback();
              } else {
                oMachineTreeNode.setName(sIPAddress + " (scanning port 3389...)");
                fScanIPAddressAndPort(sIPAddress, 3389, function (bDetected) {
                  if (bDetected) {
                    oMachineTreeNode.setName(sIPAddress + " (Windows)")
                    fCallback();
                  } else {
                    oMachineTreeNode.setName(sIPAddress + " (scanning port 80...)");
                    fScanIPAddressAndPort(sIPAddress, 80, function (bDetected) {
                      if (bDetected) {
                        oMachineTreeNode.setName(sIPAddress + " (unknown OS)")
                        fCallback();
                      } else {
                        oMachineTreeNode.remove();
                        fCallback();
                      };
                    });
                  };
                });
              };
            });
          };
        });
      };
      function fScanIPAddressAndPort(sIPAddress, uPort, fCallback) {
        var bScanComplete = false,
            uStartTime = new Date().valueOf(),
            oXHR = new XMLHttpRequest(),
            sURL = "http://" + sIPAddress + ":" + uPort,
            oTimeout = setTimeout(function fXHRTimeout() {
              if (!bScanComplete) {
                bScanComplete = true;
                oXHR.abort();
                fCallback(false);
              };
            }, 2000);
        oXHR.onreadystatechange = function fXHRReadyStateChangeEventHandler(oEvent) {
          if (oXHR.readyState == 4) {
            var uTime = new Date().valueOf() - uStartTime;
            console.log(sURL + " T+" + uTime + " " + oXHR.readyState + " " + oXHR.status);
            console.log(oEvent);
            if (!bScanComplete) {
              bScanComplete = true;
              clearTimeout(oTimeout);
              fCallback(true);
            };
          };
        };
        oXHR.open("GET", sURL);
        oXHR.send();
      };
      
      function cTreeNode(sNodeName) {
        this.oRootElement = document.createElement("div");
        oNodeNameElement = this.oRootElement.appendChild(document.createElement("div"))
        this.oNodeNameTextNode = oNodeNameElement.appendChild(document.createTextNode(sNodeName));
        this.oContainerElement = this.oRootElement.appendChild(document.createElement("div"));
        this.oContainerElement.style.setProperty("padding-left", "1em");
      };
      cTreeNode.prototype.setName = function cTreeNode_setName(sNewName) {
        this.oNodeNameTextNode.nodeValue = sNewName;
      };
      cTreeNode.prototype.appendChild = function cTreeNode_appendChild(oChildTreeNode) {
        this.oContainerElement.appendChild(oChildTreeNode.oRootElement);
        return oChildTreeNode;
      };
      cTreeNode.prototype.remove = function cTreeNode_remove() {
        this.oRootElement.parentNode.removeChild(this.oRootElement);
      };
    </script>
  </head>
  <body>
    <iframe id="oIFrame" sandbox="allow-same-origin" style="display: none"></iframe>
    
  </body>
</html>